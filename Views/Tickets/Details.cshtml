@model HelpdeskSystem.Models.TicketDetailsViewModel

@*
    Ticket details view with comments list and add-comment form.
    - Shows ticket fields (Title, Description, Status, Category, CreatedDate)
    - Lists comments (CreatedByName, CreatedDate, CommentText)
    - Provides a form to add a comment unless the ticket is Closed.
    - Provides a soft-delete button which sets IsDeleted = 1 (soft delete).
*@

<div class="container mt-4">
    <h2>Ticket Details</h2>

    <div class="mb-3">
        <h4>@Model.Title</h4>
        <p><strong>Status:</strong> @Model.Status</p>
        <p><strong>Category:</strong> @Model.CategoryName</p>
        <p><strong>Created:</strong> @Model.CreatedDate.ToString("yyyy-MM-dd HH:mm")</p>
        <p><strong>Description:</strong></p>
        <p>@Model.Description</p>
    </div>

    @* Soft-delete form: posts to Tickets/Delete. Only shown when viewing an existing (non-deleted) ticket.
       The controller performs the soft-delete by setting IsDeleted = 1 and redirects to the list. *@
    <div class="mb-3">
        <form asp-action="Delete" method="post" onsubmit="return confirm('Are you sure you want to delete this ticket?');">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" value="@Model.TicketId" />
            <button class="btn btn-danger">Delete</button>
        </form>
    </div>

    <hr />

    <h5>Comments</h5>
    @if (Model.Comments == null || !Model.Comments.Any())
    {
        <p>No comments yet.</p>
    }
    else
    {
        <div class="list-group mb-3">
            @foreach (var c in Model.Comments)
            {
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">@c.CreatedByName</h6>
                        <small>@c.CreatedDate.ToString("yyyy-MM-dd HH:mm")</small>
                    </div>
                    <p class="mb-1">@c.CommentText</p>
                </div>
            }
        </div>
    }

    <hr />

    <h5>Add Comment</h5>

    <div asp-validation-summary="All" class="text-danger"></div>

    @if (string.Equals(Model.Status, "Closed", StringComparison.OrdinalIgnoreCase))
    {
        <div class="alert alert-warning">This ticket is closed. Comments are not allowed.</div>
        <div class="mb-3">
            <textarea class="form-control" rows="4" disabled>@Model.NewCommentText</textarea>
        </div>
        <button class="btn btn-primary" disabled>Add Comment</button>
    }
    else
    {
        <form asp-action="AddComment" asp-route-id="@Model.TicketId" method="post">
            @Html.AntiForgeryToken()

            <div class="mb-3">
                <label class="form-label">Comment</label>
                <textarea name="NewCommentText" class="form-control" rows="4">@Model.NewCommentText</textarea>
                <span asp-validation-for="NewCommentText" class="text-danger"></span>
            </div>

            <button type="submit" class="btn btn-primary">Add Comment</button>
        </form>
    }

    <div class="mt-3">
        <a asp-action="Index" class="btn btn-secondary">Back to list</a>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.js"></script>
}
